generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Customer {
  id           Int      @id @default(autoincrement())
  name         String
  firstName    String?
  lastName     String?
  email        String?
  phone        String?
  address      String?
  addressLine1 String?
  addressLine2 String?
  neighborhood String?
  city         String?
  state        String?
  postalCode   String?
  country      String?
  placeId      String?
  lat          Float?
  lng          Float?
  deliveryNotes String?
  createdAt    DateTime @default(now())
  orders       Order[]

  @@index([name])
  @@index([email])
}

model Product {
  id        Int      @id @default(autoincrement())
  name      String
  category  String?
  unit      String?
  price     Float
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  items     OrderItem[]
  movements StockMovement[]
  boms      Bom[]

  @@index([name])
  @@index([category])
  @@index([active])
}

model Order {
  id         Int         @id @default(autoincrement())
  customerId Int
  status     String      @default("ABERTO")
  subtotal   Float       @default(0)
  discount   Float       @default(0)
  total      Float       @default(0)
  notes      String?
  createdAt  DateTime    @default(now())
  customer   Customer    @relation(fields: [customerId], references: [id])
  items      OrderItem[]
  payments   Payment[]
  stockMovements StockMovement[]
  inventoryMovements InventoryMovement[]
  outboxMessages OutboxMessage[]

  @@index([customerId])
  @@index([status])
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int
  unitPrice Float
  total     Float
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Payment {
  id          Int           @id @default(autoincrement())
  orderId     Int
  amount      Float
  method      String
  status      String        @default("PENDENTE")
  paidAt      DateTime?
  dueDate     DateTime?
  providerRef String?
  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model StockMovement {
  id        Int               @id @default(autoincrement())
  productId Int
  type      String
  quantity  Int
  reason    String?
  orderId   Int?
  createdAt DateTime          @default(now())
  product   Product           @relation(fields: [productId], references: [id])
  order     Order?            @relation(fields: [orderId], references: [id])

  @@index([productId])
  @@index([orderId])
  @@index([createdAt])
}

model InventoryItem {
  id               Int      @id @default(autoincrement())
  name             String
  category         String
  unit             String
  purchasePackSize Float
  purchasePackCost Float     @default(0)
  createdAt        DateTime @default(now())
  movements        InventoryMovement[]
  bomItems         BomItem[]

  @@index([name])
  @@index([category])
}

model InventoryMovement {
  id        Int      @id @default(autoincrement())
  itemId    Int
  orderId   Int?
  type      String
  quantity  Float
  reason    String?
  createdAt DateTime @default(now())
  item      InventoryItem @relation(fields: [itemId], references: [id])
  order     Order?        @relation(fields: [orderId], references: [id])

  @@index([itemId])
  @@index([orderId])
  @@index([createdAt])
}

model Bom {
  id            Int      @id @default(autoincrement())
  productId     Int
  name          String
  saleUnitLabel String?
  yieldUnits    Float?
  product       Product  @relation(fields: [productId], references: [id])
  items         BomItem[]

  @@index([productId])
}

model BomItem {
  id             Int      @id @default(autoincrement())
  bomId          Int
  itemId         Int
  qtyPerRecipe   Float?
  qtyPerSaleUnit Float?
  qtyPerUnit     Float?
  bom            Bom          @relation(fields: [bomId], references: [id], onDelete: Cascade)
  item           InventoryItem @relation(fields: [itemId], references: [id])

  @@index([bomId])
  @@index([itemId])
}

model OutboxMessage {
  id        Int      @id @default(autoincrement())
  messageId String   @unique
  channel   String   @default("whatsapp")
  to        String
  template  String
  payload   String
  status    String   @default("PENDING")
  orderId   Int?
  createdAt DateTime @default(now())
  sentAt    DateTime?
  order     Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([channel, status])
  @@index([createdAt])
  @@index([orderId])
}
